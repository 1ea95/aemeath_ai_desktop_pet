# Bug List - Ameath 桌面宠物

本文档用于记录Ameath桌面宠物测试过程中发现的bug和问题。

## Bug列表

### Bug #001: UI元素相互遮挡
**严重程度**: 中等  
**状态**: 已修复  
**发现日期**: 2026-02-21  
**修复日期**: 2026-02-22  
**影响模块**: 番茄钟、音乐播放器UI  

**问题描述**:  
番茄钟和音乐播放器的UI界面会相互遮挡，当两个功能同时开启时，其中一个界面会被另一个界面覆盖，影响用户交互体验。

**复现步骤**:  
1. 启动Ameath桌面宠物
2. 开启番茄钟功能
3. 开启音乐播放器功能
4. 观察两个UI界面的显示情况

**预期结果**:  
两个UI界面应该合理布局，不相互遮挡，用户可以同时看到并操作两个界面。

**实际结果**:  
其中一个UI界面被另一个界面覆盖，无法正常查看或操作被覆盖的界面。

**可能原因**:  
- UI元素的z-index层级设置不当
- 窗口位置计算逻辑存在问题
- 缺乏多窗口布局管理机制

**修复方案**:  
1. 创建UI组件自动管理器（`src/ui/ui_manager.py`）
2. 实现智能布局算法，自动调整多个UI窗口的位置
3. 添加窗口层级管理，确保重要UI始终可见
4. 修改所有UI组件，使其通过UI管理器进行位置计算

**相关文件**:  
- `src/ui/ui_manager.py` - UI组件自动管理器
- `src/ui/pomodoro_indicator.py` - 番茄钟UI
- `src/ui/music_panel.py` - 音乐播放器UI
- `src/ui/speech_bubble.py` - 语音气泡UI
- `src/ui/ai_chat_panel.py` - AI聊天面板UI
- `src/core/pet_core.py` - 宠物核心逻辑

**修复说明**:  
已实现UI组件自动管理器，通过智能布局算法自动调整多个UI窗口的位置，避免UI元素相互遮挡。当多个UI组件同时显示时，系统会自动计算最佳位置，确保所有组件都能正常显示且不相互重叠。

---

### Bug #002: UI组件缩放时位置不跟随中心改变
**严重程度**: 中等  
**状态**: 已修复  
**发现日期**: 2026-02-21  
**修复日期**: 2026-02-22  
**影响模块**: 所有UI组件  

**问题描述**:  
当存在UI组件时改变缩放比例，所有种类的UI都没有跟随位置中心进行相应调整，导致UI位置偏移，影响用户体验。

**复现步骤**:  
1. 启动Ameath桌面宠物
2. 打开任意UI组件（如番茄钟、音乐播放器、AI聊天面板等）
3. 改变桌面宠物的缩放比例
4. 观察UI组件的位置变化

**预期结果**:  
UI组件应该以宠物为中心，跟随缩放比例进行位置调整，保持相对位置的正确性。

**实际结果**:  
UI组件位置没有跟随缩放中心进行调整，导致UI与宠物的相对位置发生偏移。

**可能原因**:  
- 缩放变换只应用于宠物本体，未同步到UI组件
- UI组件位置计算没有考虑缩放因子
- 缺乏全局的缩放事件通知机制

**修复方案**:  
1. 在UI组件自动管理器中实现缩放事件处理
2. 在缩放变换时同步更新所有UI组件的位置
3. 将UI组件位置计算改为相对于宠物中心的相对坐标
4. 修改拖拽处理逻辑，确保缩放时UI组件正确跟随

**相关文件**:  
- `src/ui/ui_manager.py` - UI组件自动管理器
- `src/ui/` 目录下的所有UI组件文件
- `src/interaction/drag_handler.py` - 拖拽处理器
- `src/animation/animation_manager.py` - 动画管理器
- `src/core/pet_core.py` - 宠物核心逻辑

**修复说明**:  
已通过UI组件自动管理器实现UI组件位置跟随缩放中心的功能。当宠物缩放比例改变时，所有UI组件会自动更新位置，保持与宠物的相对位置关系。同时修改了拖拽处理逻辑，确保在拖拽和缩放过程中UI组件能够正确跟随宠物移动。

---

### Bug #003: 隐藏桌宠时音乐播放器UI没有跟着隐藏
**严重程度**: 中等  
**状态**: 已修复  
**发现日期**: 2026-02-21  
**修复日期**: 2026-02-22  
**影响模块**: 音乐播放器UI、桌宠显示控制  

**问题描述**:  
当音乐播放器UI显示时，选择隐藏桌宠功能，音乐播放器UI没有跟着一起隐藏，仍然显示在桌面上，与用户预期不符。

**复现步骤**:  
1. 启动Ameath桌面宠物
2. 打开音乐播放器UI
3. 右键点击桌宠，选择隐藏桌宠选项
4. 观察音乐播放器UI的显示状态

**预期结果**:  
隐藏桌宠时，所有相关的UI组件（包括音乐播放器）应该一起隐藏，保持界面的一致性。

**实际结果**:  
桌宠被隐藏了，但音乐播放器UI仍然显示在桌面上。

**可能原因**:  
- 隐藏桌宠功能只处理了主窗口的隐藏，没有通知其他UI组件
- 音乐播放器UI与桌宠主窗口的生命周期没有关联
- 缺乏全局的UI显示/隐藏状态管理机制

**修复方案**:  
1. 在UI组件自动管理器中实现全局UI状态管理
2. 在隐藏桌宠时发送通知事件，所有UI组件监听并响应
3. 将音乐播放器等UI组件的显示状态与桌宠主窗口绑定
4. 修改系统托盘和快捷菜单的隐藏/显示逻辑

**相关文件**:  
- `src/ui/ui_manager.py` - UI组件自动管理器
- `src/ui/music_panel.py` - 音乐播放器UI
- `src/src_platform/tray.py` - 系统托盘功能
- `src/ui/quick_menu.py` - 快捷菜单
- `src/core/pet_core.py` - 宠物核心逻辑

**修复说明**:  
已通过UI组件自动管理器实现全局UI状态管理，当隐藏桌宠时，所有UI组件（包括音乐播放器）会一起隐藏。修改了系统托盘和快捷菜单的隐藏/显示逻辑，确保UI组件的显示状态与桌宠主窗口保持一致。现在用户隐藏桌宠时，所有相关的UI组件都会一起隐藏，保持界面的一致性。

---

### Bug #004: 配置列表中的不透明度错写成透明度
**严重程度**: 低  
**状态**: 已修复  
**发现日期**: 2026-02-21  
**修复日期**: 2026-02-22  
**影响模块**: 配置界面  

**问题描述**:  
在配置列表中，控制桌宠不透明度的选项被错误地标记为"透明度"，导致用户界面术语不准确，可能引起用户困惑。

**复现步骤**:  
1. 启动Ameath桌面宠物
2. 打开配置界面
3. 查找控制桌宠显示透明度的选项
4. 观察选项标签文字

**预期结果**:  
配置选项应该正确标记为"不透明度"，因为该参数实际控制的是桌宠的不透明程度（值越高越不透明）。

**实际结果**:  
配置选项被错误地标记为"透明度"，与实际功能不符。

**可能原因**:  
- 开发时的命名错误或翻译错误
- 对透明度/不透明度概念理解有误
- 代码实现与UI标签不一致

**修复方案**:  
1. 将系统托盘菜单中的"透明度"改为"不透明度"

**相关文件**:  
- `src/src_platform/tray.py` - 系统托盘功能

**修复说明**:  
已将系统托盘菜单中的"透明度"选项更正为"不透明度"，使UI术语与实际功能保持一致。

---

### Bug #005: 系统托盘菜单状态不同步
**严重程度**: 中等  
**状态**: 已修复  
**发现日期**: 2026-02-21  
**修复日期**: 2026-02-22  
**影响模块**: 系统托盘、快捷菜单  

**问题描述**:  
在双击桌宠出现的快捷栏中选择隐藏时，系统托盘菜单没有同步将配置项从"隐藏"改成"显示"，导致菜单状态与实际桌宠显示状态不一致。

**复现步骤**:  
1. 启动Ameath桌面宠物
2. 双击桌宠打开快捷菜单
3. 在快捷菜单中选择"隐藏"选项
4. 查看系统托盘右键菜单中的显示/隐藏选项

**预期结果**:  
系统托盘菜单中的显示/隐藏选项应该与桌宠的实际状态保持同步，当桌宠被隐藏时，选项应该显示为"显示"。

**实际结果**:  
系统托盘菜单中的选项仍然显示为"隐藏"，与桌宠实际被隐藏的状态不符。

**可能原因**:  
- 快捷菜单和系统托盘菜单使用不同的状态变量
- 缺乏全局状态管理机制
- 隐藏操作没有通知所有相关UI组件更新状态

**修复方案**:  
1. 在快捷菜单的`_hide_pet`方法中添加系统托盘菜单更新逻辑

**相关文件**:  
- `src/ui/quick_menu.py` - 快捷菜单

**修复说明**:  
已在快捷菜单的`_hide_pet`方法中添加系统托盘菜单更新逻辑，确保隐藏桌宠时系统托盘菜单状态同步更新。

---

### Bug #006: 快捷菜单中打开AI对话无法正常回答
**严重程度**: 中等  
**状态**: 已修复  
**发现日期**: 2026-02-23  
**修复日期**: 2026-02-23  
**影响模块**: AI对话系统、快捷菜单

**问题描述**:  
通过双击桌宠打开快捷菜单，点击“AI聊天”按钮后，AI对话窗口无法正常回答用户输入的问题。

**复现步骤**:  
1. 双击桌宠打开快捷菜单
2. 点击“AI聊天”按钮
3. 在弹出的AI对话窗口中输入问题
4. 观察AI回复情况

**预期结果**:  
AI应该能够正常回答用户的问题，显示回复内容。

**实际结果**:  
AI对话窗口无法正常回答，可能显示错误信息或无任何响应。

**可能原因**:  
- 快捷菜单调用的AI对话窗口没有正确初始化AI引擎
- 快捷菜单和AI对话窗口之间的参数传递有误
- AI对话窗口没有正确加载配置信息

**修复方案**:  
1. 检查快捷菜单中AI聊天按钮的回调函数实现
2. 确保AI对话窗口正确初始化并加载配置
3. 验证AI引擎在快捷菜单调用时是否正常工作

**相关文件**:  
- `src/ui/quick_menu.py` - 快捷菜单
- `src/ui/ai_chat_panel.py` - AI聊天面板
- `src/ai/chat_engine.py` - AI对话引擎

---

### Bug #007: 托盘菜单调用AI对话时窗口类型错误
**严重程度**: 中等  
**状态**: 已修复  
**发现日期**: 2026-02-23  
**修复日期**: 2026-02-23  
**影响模块**: AI对话系统、系统托盘

**问题描述**:  
通过系统托盘菜单调用AI对话功能时，产生的窗口不是桌宠配套的定制窗口，而是普通的Windows弹窗。

**复现步骤**:  
1. 右键点击系统托盘图标
2. 选择“AI对话”选项
3. 观察弹出的窗口样式和功能

**预期结果**:  
应该弹出与桌宠风格一致的定制AI对话窗口，保持界面风格统一。

**实际结果**:  
弹出的是普通的Windows弹窗，缺少桌宠的定制样式和功能。

**可能原因**:  
- 托盘菜单调用的AI对话窗口使用了不同的窗口类或创建方法
- 托盘菜单和快捷菜单使用了不同的AI对话窗口实现
- 窗口样式初始化代码在托盘菜单调用路径中缺失

**修复方案**:  
1. 确保托盘菜单和快捷菜单使用相同的AI对话窗口创建方法
2. 检查窗口样式初始化代码是否在所有调用路径中执行
3. 统一AI对话窗口的创建和初始化流程

**相关文件**:  
- `src/platform/tray.py` - 系统托盘
- `src/ui/ai_chat_panel.py` - AI聊天面板

---

### Bug #008: 快捷栏中的AI对话启动时无法正常跟随
**严重程度**: 中等  
**状态**: 已修复  
**发现日期**: 2026-02-23  
**修复日期**: 2026-02-23  
**影响模块**: AI对话系统、UI管理

**问题描述**:  
当从快捷栏启动AI对话时，如果之前曾经调用过对话输入框，对话输入框就无法正常跟随桌宠，而是出现在了屏幕左上角。

**复现步骤**:  
1. 双击桌宠打开快捷菜单
2. 点击“AI聊天”按钮，打开AI对话面板
3. 关闭AI对话面板
4. 再次双击桌宠打开快捷菜单
5. 再次点击“AI聊天”按钮
6. 观察AI对话面板的位置

**预期结果**:  
AI对话面板应该出现在桌宠右侧，并能够正常跟随桌宠移动。

**实际结果**:  
AI对话面板出现在屏幕左上角，无法正常跟随桌宠移动。

**可能原因**:  
- AI聊天面板关闭后，UI管理器中仍然保留着对旧实例的引用
- 新创建的AI聊天面板实例没有被正确注册到UI管理器中
- AI聊天面板的尺寸在UI管理器中与实际窗口尺寸不匹配
- 窗口创建时没有设置正确的初始位置

**修复方案**:  
1. 在`_open_ai_chat_panel`方法中，当创建新的AI聊天面板时，重新注册到UI管理器
2. 修正了AI聊天面板的尺寸，从400x300改为260x45，与实际创建的窗口尺寸一致
3. 在`_create_window`方法中，设置初始位置为桌宠右侧，避免窗口出现在屏幕左上角
4. 在`show`方法中，添加对`update_layout`的直接调用，确保布局立即更新

**相关文件**:  
- `src/core/pet_core.py` - 宠物核心逻辑
- `src/ui/ai_chat_panel.py` - AI聊天面板
- `src/ui/ui_manager.py` - UI组件自动管理器

**修复说明**:  
已修复AI聊天面板无法正常跟随桌宠的问题。当创建新的AI聊天面板时，会重新注册到UI管理器，确保引用正确。同时修正了AI聊天面板的尺寸，与实际创建的窗口尺寸一致。在窗口创建时立即设置正确的初始位置，避免窗口出现在屏幕左上角。在show方法中添加对update_layout的直接调用，确保布局立即更新。

---

## Bug报告模板

如需添加新的bug，请使用以下格式：

### Bug #[编号]: [简短描述]
**严重程度**: [低/中/高/严重]  
**状态**: [未解决/处理中/已解决/已验证]  
**发现日期**: [YYYY-MM-DD]  
**影响模块**: [受影响的模块名称]  

**问题描述**:  
[详细描述bug的具体表现和影响]

**复现步骤**:  
1. [步骤1]
2. [步骤2]
3. [步骤3]

**预期结果**:  
[描述应该出现的正确结果]

**实际结果**:  
[描述实际发生的错误结果]

**可能原因**:  
[分析可能导致bug的原因]

**建议解决方案**:  
[提供修复建议]

**相关文件**:  
[列出可能相关的代码文件路径]
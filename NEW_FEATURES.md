# 新功能使用说明

## 🎉 v3.0版本新增功能

### 1. 语音交互系统 🎤

**功能描述：**
新增完整的语音交互系统，支持语音唤醒、语音识别和语音合成，实现与桌面宠物的自然语言交互。

**核心组件：**
- **关键词检测引擎** - 基于sherpa-onnx的离线关键词检测
- **语音识别引擎** - 基于阿里云ASR的语音转文字服务
- **语音合成引擎** - 基于阿里云TTS的文字转语音服务
- **语音助手** - 整合所有语音功能的主控制器

**使用方法：**
1. 在托盘菜单中启用 **语音功能** 开关
2. 配置语音相关API密钥（阿里云ASR和TTS）
3. 启用 **语音唤醒** 功能后，说出唤醒词触发对话
4. 宠物会显示"我在听~"提示，然后说出你的问题
5. 系统会自动识别语音并转换为文字，发送给AI引擎
6. AI回复会以语音形式播放

**功能特点：**
- 🎯 **离线唤醒** - 本地关键词检测，保护隐私
- 🎧 **清晰识别** - 阿里云ASR高精度语音识别
- 🔊 **自然语音** - 阿里云TTS高质量语音合成
- 🤖 **智能对话** - 与AI聊天引擎无缝集成
- 🔄 **自动重连** - 网络异常时自动重试

**注意事项：**
- 需要配置阿里云ASR和TTS的API密钥
- 首次使用需要下载语音模型文件
- 语音功能会消耗网络流量和API配额

---

### 2. LLM引擎升级 🧠

**功能描述：**
重构AI对话引擎，支持流式回复，优化多服务商API调用，增强人格系统。

**技术改进：**
- **流式回复** - 实时显示AI回复过程，提升交互体验
- **多服务商优化** - 统一API接口，支持更多服务商
- **人格系统增强** - 丰富角色设定，提供更自然的对话体验
- **错误处理改进** - 完善的异常处理和重试机制
- **性能优化** - 减少资源占用，提高响应速度

**新增人格：**
- **aemeath** - 桌面宠物专属人设，更符合角色特点
- **helpful** - 专业助手模式，提供准确有用的建议
- **cute** - 超萌模式，可爱俏皮的对话风格
- **tsundere** - 傲娇模式，外冷内热的个性表达

---

### 3. 架构重构与优化 🏗️

**功能描述：**
全面优化代码结构和模块化设计，提高代码可维护性和扩展性。

**主要改进：**
- **模块化架构** - 清晰的模块划分，降低耦合度
- **配置管理优化** - 统一的配置加载和保存机制
- **错误处理增强** - 完善的异常捕获和错误恢复
- **日志系统** - 详细的运行日志，便于问题排查
- **性能优化** - 减少内存占用，提高运行效率

**新增工具：**
- `fix_config.py` - 配置文件修复工具
- `fix_glm_config.py` - GLM配置快速设置工具

---

## 📜 先前版本功能 (v2.0)

## 🎉 新增功能概览

### 1. 点击互动反馈 💬

**功能描述：**
单击宠物时，宠物会显示对话气泡，根据时间显示不同的问候语或互动台词。

**使用方法：**
- 单击宠物（非拖动）
- 宠物会显示随机的互动对话
- 对话气泡 2-4 秒后自动消失

**对话类型：**
- **时间段问候**：根据当前时间显示（早上好/中午好/晚上好等）
- **随机互动**："我在这里陪着你哦~"、"记得多喝水！"等
- **点击反应**："哎呀，被发现了！"、"哈哈，好痒！"等

---

### 2. 智能作息系统 🌙

**功能描述：**
根据系统时间自动调整宠物的行为模式，包括睡眠状态、提醒功能等。

**时间段划分：**
- **凌晨 (0:00-6:00)**：睡眠模式 - 移动缓慢，显示"困了"提示
- **早上 (6:00-11:00)**：早晨模式 - 元气满满
- **中午 (11:00-14:00)**：午休模式 - 活跃但会提醒休息
- **下午 (14:00-18:00)**：下午模式 - 正常工作
- **晚上 (18:00-22:00)**：晚间模式 - 轻松状态
- **深夜 (22:00-24:00)**：准备睡眠 - 移动减慢

**智能提醒功能（每30-60分钟）：**
- 💧 **喝水提醒**："记得喝水哦~"
- 😴 **休息提醒**："休息一下吧~"
- 🪑 **坐姿提醒**："注意坐姿哦~"

---

### 3. 双击快捷菜单 ⚡

**功能描述：**
双击宠物弹出快捷操作菜单，无需右键托盘图标即可快速操作。

**使用方法：**
- 快速双击宠物（300ms内两次点击）
- 弹出快捷菜单
- 菜单会自动关闭（点击外部或选择功能后）

**菜单功能：**
- ⏸️ 暂停/继续
- 👻 鼠标穿透
- 🐭 跟随鼠标
- 🔍 放大
- 🔎 缩小
- 👁️ 隐藏宠物
- ❌ 关闭菜单

---

### 4. 全局快捷键 ⌨️

**功能描述：**
使用键盘快捷键在任何地方控制宠物，即使宠物被其他窗口遮挡。

**快捷键列表：**

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+Shift+H` | 显示/隐藏宠物 |
| `Ctrl+Shift+P` | 暂停/继续活动 |
| `Ctrl+Shift+S` | 显示快捷菜单 |
| `Ctrl+Shift+Q` | 退出程序 |

**使用场景：**
- 在全屏工作时快速隐藏宠物
- 不需要鼠标操作托盘图标
- 快捷控制，提高效率

---

## 📝 文件变更

### 新增文件
- `speech_bubble.py` - 对话气泡模块
- `quick_menu.py` - 快捷菜单模块
- `hotkey.py` - 全局快捷键模块

### 修改文件
- `pet.py` - 添加互动系统、作息系统、双击菜单集成
- `main.py` - 注册全局快捷键
- `constants.py` - 添加作息配置参数

---

## 🔧 技术实现

### 点击互动检测
- 使用 300ms 时间窗口区分单击和双击
- 如果移动距离超过 5 像素，则判定为拖动而非点击
- 单击显示互动对话，双击显示快捷菜单

### 智能作息
- 每分钟检查一次当前时间段
- 根据时间段调整移动速度和待机概率
- 定时发送健康提醒（喝水、休息、坐姿）

### 全局快捷键
- 使用 Windows API `RegisterHotKey` 注册全局热键
- 拦截窗口消息处理快捷键事件
- 程序退出时自动注销热键

---

## 💡 使用建议

1. **首次使用**：单击宠物几次看看它会说什么！
2. **深夜工作**：观察宠物进入睡眠模式后的缓慢移动
3. **效率操作**：记住 `Ctrl+Shift+H` 快速隐藏/显示
4. **双击菜单**：关闭鼠标穿透后，双击宠物快速操作

---

## 🐛 注意事项

1. 全局快捷键需要程序有窗口句柄，启动后约 100ms 才能注册成功
2. 如果在睡眠时段（0:00-6:00）启动，宠物会立即进入睡眠模式
3. 双击菜单在宠物被其他窗口遮挡时可能显示在错误位置
4. 全局快捷键可能与某些应用程序的快捷键冲突

---

## 🎨 自定义建议

### 修改对话内容
编辑 `speech_bubble.py` 中的以下变量：
- `GREETINGS` - 时间段问候语
- `RANDOM_LINES` - 随机互动台词
- `CLICK_REACTIONS` - 点击反应台词

### 调整作息参数
编辑 `constants.py` 中的：
- `TIME_*_START` - 时间段划分
- `REMINDERS` - 提醒间隔和消息
- `SLEEP_SPEED_MULTIPLIER` - 睡眠时速度

### 修改快捷键
编辑 `hotkey.py` 中的 `_register_default_hotkeys` 方法，
可以更改快捷键组合或添加新的快捷键。

---

*祝你使用愉快！有任何问题欢迎反馈~*